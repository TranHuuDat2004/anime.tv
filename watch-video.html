<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem Phim</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/watch-video-style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="icon" href="images/favicon.png" type="image/x-icon">
</head>

<body>
    <header>
        <nav class="navbar">
            <div class="container">
                <a href="index.html" class="navbar-logo"><img src="images/logo.png" height="80"></a>
                <ul class="navbar-nav">
                    <li><a href="index.html" class="active">Trang Chủ</a></li>
                    <li><a href="#">Bộ sưu tập</a></li>
                    <li><a href="#">Ảnh GIF</a></li>
                    <li><a href="#">Manga</a></li>
                    <li><a href="#">Games</a></li>
                    <li><a href="#">Giới thiệu</a></li>
                </ul>
                <div class="navbar-actions">
                    <a href="search.html"> <button class="search-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                    </a>
                    <a href="#" id="loginButton" class="login-button">Đăng Nhập</a>
                </div>
            </div>
        </nav>
    </header>
    <div id="featureNotification" class="notification">
        Tính năng này đang được cập nhật!
    </div>
    <main id="watch-page">
        <div class="video-player-container" id="videoPlayerWrapper">
            <!-- Iframe sẽ được tạo và chèn vào đây bởi JavaScript -->
        </div>

        <div class="container video-info-controls">
            <div class="episode-details">
                <h1 id="animeTitleWatchPage">Tên Anime</h1>
                <h2 id="episodeTitleWatchPage">Tập X: Tên tập phim</h2>
                <p id="episodeSubDubWatchPage" class="episode-subdub-info"></p>
            </div>
            <div class="episode-navigation">
                <a href="#" id="prevEpisodeBtn" class="btn btn-secondary disabled">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Tập Trước
                </a>
                <a href="anime-detail.html" id="backToDetailBtn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="btn-icon">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    DS Tập
                </a>
                <a href="#" id="nextEpisodeBtn" class="btn btn-primary disabled">
                    Tập Tiếp Theo
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
            </div>
        </div>
    </main>

    <!-- PHẦN MỚI: DANH SÁCH CÁC TẬP KHÁC -->
    <section class="watch-page-episode-list-section container">
        <h2 class="section-title">Các tập khác</h2>
        <div id="watchPageSeasonContainer">
            <!-- Danh sách tập sẽ được load vào đây -->
        </div>
    </section>
    <!-- KẾT THÚC PHẦN MỚI -->

    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="#">Về chúng tôi</a>
                <a href="#">Trợ giúp/FAQ</a>
                <a href="#">Điều khoản sử dụng</a>
                <a href="#">Chính sách riêng tư</a>
            </div>
            <p>© 2024 ANIME.TV. Dựa trên ý tưởng từ Crunchyroll.</p>
        </div>
    </footer>

    <script src="js/data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('animeId');
            const seasonNumParam = urlParams.get('season');
            const episodeNumParam = urlParams.get('ep');

            const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');

            if (!animeId || !seasonNumParam || !episodeNumParam) {
                document.getElementById('animeTitleWatchPage').textContent = "Lỗi"; // Giữ ngắn gọn
                document.getElementById('episodeTitleWatchPage').textContent = "Thiếu thông tin tập phim.";
                videoPlayerWrapper.innerHTML = '<p class="error-message">Không thể tải video. Vui lòng kiểm tra lại đường dẫn.</p>';
                return;
            }

            const seasonNum = parseInt(seasonNumParam);
            const epNumInSeason = parseInt(episodeNumParam);

            if (typeof animeData === 'undefined' || !animeData) {
                console.error("Lỗi: animeData không được định nghĩa hoặc chưa tải xong.");
                document.getElementById('episodeTitleWatchPage').textContent = "Lỗi tải dữ liệu Anime";
                return;
            }

            const anime = animeData.find(a => a.id === animeId);

            if (!anime) {
                document.getElementById('animeTitleWatchPage').textContent = "Lỗi";
                document.getElementById('episodeTitleWatchPage').textContent = "Không tìm thấy anime.";
                return;
            }

            const season = anime.episodes.seasons.find(s => s.seasonNum === seasonNum);
            if (!season) {
                document.getElementById('animeTitleWatchPage').textContent = anime.title;
                document.getElementById('episodeTitleWatchPage').textContent = "Không tìm thấy mùa phim.";
                return;
            }

            const currentEpisode = season.episodes.find(e => e.epNumInSeason === epNumInSeason);

            if (!currentEpisode || !currentEpisode.videoUrl || currentEpisode.videoUrl === "#") {
                document.getElementById('animeTitleWatchPage').textContent = anime.title;
                document.getElementById('episodeTitleWatchPage').textContent = "Không tìm thấy tập phim hoặc link video không hợp lệ.";
                videoPlayerWrapper.innerHTML = '<p class="error-message">Link video không tồn tại hoặc không hợp lệ.</p>';
                return;
            }

            // Cập nhật tiêu đề trang và thông tin
            document.title = `Xem: ${anime.title} - Tập ${currentEpisode.epNumOverall}`;
            document.getElementById('animeTitleWatchPage').textContent = anime.title;
            document.getElementById('episodeTitleWatchPage').textContent = `Tập ${currentEpisode.epNumOverall} (Mùa ${season.seasonNum} - Tập ${currentEpisode.epNumInSeason}): ${currentEpisode.title}`;

            let subDubText = [];
            if (currentEpisode.sub) subDubText.push("Phụ đề");
            if (currentEpisode.dub) subDubText.push("Thuyết minh");
            document.getElementById('episodeSubDubWatchPage').textContent = subDubText.join(' | ');

            // TẠO IFRAME CHO VIMEO
            const vimeoVideoUrl = currentEpisode.videoUrl;
            console.log("Đang chuẩn bị nhúng Vimeo video:", vimeoVideoUrl);

            if (vimeoVideoUrl.includes('player.vimeo.com/video/')) {
                videoPlayerWrapper.innerHTML = ''; // Xóa nội dung cũ

                const iframe = document.createElement('iframe');
                iframe.id = 'vimeoPlayer'; // Đặt ID mới hoặc giữ ID cũ nếu CSS không bị ảnh hưởng
                iframe.src = vimeoVideoUrl;

                // Các thuộc tính chuẩn cho Vimeo embed
                // width và height sẽ được quản lý bởi CSS
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture; clipboard-write');
                // Vimeo không cần các prefix mozallowfullscreen, webkitallowfullscreen như Google Drive trước đây
                iframe.setAttribute('allowfullscreen', 'true');
                // iframe.setAttribute('title', currentEpisode.title); // Có thể thêm title cho accessibility

                videoPlayerWrapper.appendChild(iframe);
                console.log("Đã tạo và chèn iframe Vimeo:", vimeoVideoUrl);

                iframe.onerror = () => {
                    console.error("Lỗi khi tải nội dung iframe Vimeo. URL:", vimeoVideoUrl);
                    videoPlayerWrapper.innerHTML = `<p class="error-message">Rất tiếc, không thể tải video từ Vimeo. Vui lòng kiểm tra lại link hoặc thử lại sau.</p>`;
                };

            } else {
                console.error("Link video không phải là link nhúng Vimeo hợp lệ:", vimeoVideoUrl);
                videoPlayerWrapper.innerHTML = `<p class="error-message">Định dạng link video không hợp lệ. Link gốc: ${vimeoVideoUrl}</p>`;
                return;
            }

            // THÊM LOGIC ĐỂ HIỂN THỊ DANH SÁCH CÁC TẬP KHÁC:

            const watchPageSeasonContainer = document.getElementById('watchPageSeasonContainer');
            if (watchPageSeasonContainer && anime && anime.episodes && anime.episodes.seasons) {
                watchPageSeasonContainer.innerHTML = ''; // Xóa nội dung cũ

                anime.episodes.seasons.forEach(currentSeasonData => { // Đổi tên biến để tránh trùng
                    const seasonBlock = document.createElement('div');
                    // Tái sử dụng class từ anime-detail-style.css nếu muốn style giống hệt
                    seasonBlock.className = 'season-block'; // Giả sử bạn muốn style giống

                    const seasonTitle = document.createElement('h3');
                    // Không cần hiển thị lại tiêu đề season nếu chỉ có 1 season hoặc bạn không muốn
                    // seasonTitle.textContent = `Season ${currentSeasonData.seasonNum}${currentSeasonData.seasonTitle ? (': ' + currentSeasonData.seasonTitle) : ''}`;
                    // seasonBlock.appendChild(seasonTitle); // Bỏ qua tiêu đề season trên trang xem

                    // Tái sử dụng class từ anime-detail-style.css
                    const episodeListContainer = document.createElement('div');
                    episodeListContainer.className = 'episode-list-container';

                    const episodeList = document.createElement('div');
                    episodeList.className = 'episode-list'; // Dùng grid layout từ anime-detail-style.css

                    currentSeasonData.episodes.forEach(ep => {
                        const episodeItemLink = document.createElement('a');
                        episodeItemLink.href = `watch-video.html?animeId=${anime.id}&season=${currentSeasonData.seasonNum}&ep=${ep.epNumInSeason}`;
                        episodeItemLink.className = 'episode-item'; // Tái sử dụng class

                        // Đánh dấu tập đang xem (nếu muốn)
                        if (currentSeasonData.seasonNum === seasonNum && ep.epNumInSeason === epNumInSeason) {
                            episodeItemLink.classList.add('playing-now'); // Class để style riêng
                        }

                        if (!ep.videoUrl || ep.videoUrl === "#") {
                            episodeItemLink.classList.add('disabled');
                        }

                        const thumbnailWrapper = document.createElement('div');
                        thumbnailWrapper.className = 'episode-thumbnail-wrapper';

                        const epThumbnail = document.createElement('img');
                        epThumbnail.src = ep.thumbnail || 'https://via.placeholder.com/280x158?text=No+Thumb';
                        epThumbnail.alt = `Thumbnail ${ep.title}`;
                        epThumbnail.className = 'episode-thumbnail';
                        thumbnailWrapper.appendChild(epThumbnail);

                        const playIcon = document.createElement('span');
                        playIcon.className = 'play-icon-list';
                        playIcon.innerHTML = '►';
                        thumbnailWrapper.appendChild(playIcon);
                        episodeItemLink.appendChild(thumbnailWrapper);

                        const epInfo = document.createElement('div');
                        epInfo.className = 'episode-info';

                        const epNumber = document.createElement('span');
                        epNumber.className = 'episode-number';
                        epNumber.textContent = `Tập ${ep.epNumInSeason}`; // Chỉ hiển thị số tập trong mùa
                        epInfo.appendChild(epNumber);

                        const epTitle = document.createElement('h4');
                        epTitle.className = 'episode-title';
                        epTitle.textContent = ep.title;
                        epInfo.appendChild(epTitle);

                        // Không cần hiển thị duration và sub/dub ở đây để tiết kiệm không gian
                        // const durationSubdubWrapper = document.createElement('div');
                        // ...

                        episodeItemLink.appendChild(epInfo);
                        episodeList.appendChild(episodeItemLink);
                    });
                    episodeListContainer.appendChild(episodeList);
                    seasonBlock.appendChild(episodeListContainer);
                    watchPageSeasonContainer.appendChild(seasonBlock);
                });
            }


            // Nút trở về trang chi tiết
            document.getElementById('backToDetailBtn').href = `anime-detail.html?id=${animeId}`;

            // Logic cho nút Tập Trước / Tập Tiếp Theo
            let currentEpisodeIndexInSeason = season.episodes.findIndex(e => e.epNumInSeason === epNumInSeason);

            const prevEpisodeBtn = document.getElementById('prevEpisodeBtn');
            prevEpisodeBtn.classList.add('disabled');
            prevEpisodeBtn.href = "#";
            if (currentEpisodeIndexInSeason > 0) {
                const prevEp = season.episodes[currentEpisodeIndexInSeason - 1];
                if (prevEp && prevEp.videoUrl && prevEp.videoUrl !== "#") {
                    prevEpisodeBtn.href = `watch-video.html?animeId=${animeId}&season=${season.seasonNum}&ep=${prevEp.epNumInSeason}`;
                    prevEpisodeBtn.classList.remove('disabled');
                }
            } else {
                const currentSeasonIndex = anime.episodes.seasons.findIndex(s => s.seasonNum === seasonNum);
                if (currentSeasonIndex > 0) {
                    const prevSeason = anime.episodes.seasons[currentSeasonIndex - 1];
                    if (prevSeason.episodes.length > 0) {
                        const lastEpOfPrevSeason = prevSeason.episodes[prevSeason.episodes.length - 1];
                        if (lastEpOfPrevSeason && lastEpOfPrevSeason.videoUrl && lastEpOfPrevSeason.videoUrl !== "#") {
                            prevEpisodeBtn.href = `watch-video.html?animeId=${animeId}&season=${prevSeason.seasonNum}&ep=${lastEpOfPrevSeason.epNumInSeason}`;
                            prevEpisodeBtn.classList.remove('disabled');
                        }
                    }
                }
            }

            const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
            nextEpisodeBtn.classList.add('disabled');
            nextEpisodeBtn.href = "#";
            if (currentEpisodeIndexInSeason < season.episodes.length - 1) {
                const nextEp = season.episodes[currentEpisodeIndexInSeason + 1];
                if (nextEp && nextEp.videoUrl && nextEp.videoUrl !== "#") {
                    nextEpisodeBtn.href = `watch-video.html?animeId=${animeId}&season=${season.seasonNum}&ep=${nextEp.epNumInSeason}`;
                    nextEpisodeBtn.classList.remove('disabled');
                }
            } else {
                const currentSeasonIndex = anime.episodes.seasons.findIndex(s => s.seasonNum === seasonNum);
                if (currentSeasonIndex < anime.episodes.seasons.length - 1) {
                    const nextSeason = anime.episodes.seasons[currentSeasonIndex + 1];
                    if (nextSeason.episodes.length > 0) {
                        const firstEpOfNextSeason = nextSeason.episodes[0];
                        if (firstEpOfNextSeason && firstEpOfNextSeason.videoUrl && firstEpOfNextSeason.videoUrl !== "#") {
                            nextEpisodeBtn.href = `watch-video.html?animeId=${animeId}&season=${nextSeason.seasonNum}&ep=${firstEpOfNextSeason.epNumInSeason}`;
                            nextEpisodeBtn.classList.remove('disabled');
                        }
                    }
                }
            }

            // --- Xử lý Notification cho nút Đăng Nhập ---
            const loginButton = document.getElementById('loginButton');
            const notificationElement = document.getElementById('featureNotification');
            let notificationTimeout; // Biến để lưu timeout

            if (loginButton && notificationElement) {
                loginButton.addEventListener('click', function (event) {
                    event.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ <a>

                    // Xóa timeout cũ nếu có (để tránh nhiều notification chồng chéo)
                    if (notificationTimeout) {
                        clearTimeout(notificationTimeout);
                    }

                    // Hiển thị notification
                    notificationElement.textContent = "Tính năng Đăng Nhập đang được cập nhật!"; // Bạn có thể tùy chỉnh nội dung
                    notificationElement.classList.remove('hide'); // Xóa class hide (nếu có từ lần trước)
                    notificationElement.classList.add('show');

                    // Tự động ẩn notification sau một khoảng thời gian
                    notificationTimeout = setTimeout(() => {
                        notificationElement.classList.remove('show');
                        notificationElement.classList.add('hide');
                    }, 3000); // Ẩn sau 3 giây (3000ms)
                });
            }
            // --- Kết thúc xử lý Notification ---
        });


    </script>
</body>

</html>